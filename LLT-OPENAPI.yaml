openapi: 3.1.0
info:
  title: LLT Assistant Backend API
  version: 0.1.0
  description: |
    REST API that powers the LLT Assistant VSCode extension. It mirrors the
    current DeepSeek-based workflow: build Python function context, identify
    test scenarios, generate pytest code, and supplement existing tests.
servers:
  - url: https://api.example.com
    description: Placeholder server
tags:
  - name: Analysis
    description: Python AST / context extraction
  - name: Generation
    description: Two-stage test scenario & code generation
  - name: Supplement
    description: Add new tests to existing suites
paths:
  /api/function-context:
    post:
      tags: [Analysis]
      summary: Build structured function context from Python source
      description: >
        Optional helper when the client cannot run the local AST analyzer.
        Mirrors the FunctionContext data that the VSCode extension expects.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FunctionContextRequest'
      responses:
        '200':
          description: Function context built successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FunctionContextResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/tests/scenarios:
    post:
      tags: [Generation]
      summary: Stage 1 – identify candidate test scenarios
      description: >
        Consumes FunctionContext plus the user’s natural-language description
        and returns a Stage1Response compatible with the existing VSCode flow.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Stage1Request'
      responses:
        '200':
          description: Stage 1 completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Stage1ResponseWrapper'
        '400':
          $ref: '#/components/responses/BadRequest'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/tests/generate:
    post:
      tags: [Generation]
      summary: Stage 2 – generate pytest code from confirmed scenarios
      description: >
        Takes FunctionContext plus confirmed scenarios (either a Stage1 response
        payload or a request id) and returns Stage2Response data that the
        existing TestGenerationController can consume directly.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Stage2Request'
      responses:
        '200':
          description: Stage 2 completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Stage2ResponseWrapper'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Stage1/Stage2 mismatch (e.g., unknown request id)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/tests/supplement:
    post:
      tags: [Supplement]
      summary: Generate additional test methods for an existing suite
      description: >
        Mirrors AgentFlowController.supplementTestScenarios: accepts the current
        test file, list of covered scenarios, optional function code, and the
        user’s description of new cases.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SupplementRequest'
      responses:
        '200':
          description: Supplementary tests generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SupplementResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/ServerError'
components:
  schemas:
    FunctionContextRequest:
      type: object
      required: [source_code, function_name]
      properties:
        source_code:
          type: string
          description: Full text of the Python file or the function block
        file_path:
          type: string
          description: Workspace-relative path for reference
        module_path:
          type: string
          description: Python module path (e.g., package.module)
        function_name:
          type: string
        client_metadata:
          $ref: '#/components/schemas/ClientMetadata'
    FunctionContextResponse:
      type: object
      required: [function_context, elapsed_ms]
      properties:
        function_context:
          $ref: '#/components/schemas/FunctionContext'
        analysis_warnings:
          type: array
          items:
            type: string
        elapsed_ms:
          type: integer
        request_id:
          type: string
    Stage1Request:
      type: object
      required: [function_context, user_description]
      properties:
        function_context:
          $ref: '#/components/schemas/FunctionContext'
        user_description:
          type: string
          minLength: 1
        stage1_config:
          $ref: '#/components/schemas/Stage1Config'
        client_metadata:
          $ref: '#/components/schemas/ClientMetadata'
    Stage1ResponseWrapper:
      type: object
      required: [stage1_response, token_usage, request_id]
      properties:
        stage1_response:
          $ref: '#/components/schemas/Stage1Response'
        token_usage:
          $ref: '#/components/schemas/TokenUsage'
        input_guidance:
          $ref: '#/components/schemas/InputGuidance'
        request_id:
          type: string
    Stage2Request:
      type: object
      required: [function_context, confirmed_scenarios]
      properties:
        function_context:
          $ref: '#/components/schemas/FunctionContext'
        confirmed_scenarios:
          type: array
          description: >
            The scenarios the user accepted; typically the union of Stage1
            identified/suggested items plus any user additions.
          items:
            $ref: '#/components/schemas/IdentifiedScenario'
        stage1_response:
          $ref: '#/components/schemas/Stage1Response'
        stage1_request_id:
          type: string
          description: Use when referencing a cached Stage1 result.
        user_additional_notes:
          type: string
        stage2_config:
          $ref: '#/components/schemas/Stage2Config'
        client_metadata:
          $ref: '#/components/schemas/ClientMetadata'
    Stage2ResponseWrapper:
      type: object
      required: [stage2_response, token_usage, request_id]
      properties:
        stage2_response:
          $ref: '#/components/schemas/Stage2Response'
        token_usage:
          $ref: '#/components/schemas/TokenUsage'
        warnings:
          type: array
          items:
            type: string
        request_id:
          type: string
        related_stage1_request_id:
          type: string
    SupplementRequest:
      type: object
      required: [existing_test_code, existing_scenarios, new_scenario_description]
      properties:
        existing_test_code:
          type: string
        existing_scenarios:
          type: array
          items:
            type: string
        function_code:
          type: string
          description: Function under test; optional but improves quality
        new_scenario_description:
          type: string
        stage2_config:
          $ref: '#/components/schemas/Stage2Config'
        client_metadata:
          $ref: '#/components/schemas/ClientMetadata'
    SupplementResponse:
      type: object
      required: [success, new_test_code, new_test_count]
      properties:
        success:
          type: boolean
        new_test_code:
          type: string
          description: Raw Python snippet containing def test_* blocks
        new_test_count:
          type: integer
        coverage_summary:
          type: string
        token_usage:
          $ref: '#/components/schemas/TokenUsage'
        suggested_insert_mode:
          type: string
          enum: [append, replace_class, replace_file]
        request_id:
          type: string
    FunctionContext:
      type: object
      required:
        - signature
        - source_code
        - body_analysis
        - imports
        - documentation
        - file_path
        - module_path
        - line_range
      properties:
        signature:
          $ref: '#/components/schemas/FunctionSignature'
        source_code:
          type: string
        body_analysis:
          $ref: '#/components/schemas/FunctionBodyAnalysis'
        class_context:
          $ref: '#/components/schemas/ClassContext'
          nullable: true
        imports:
          type: array
          items:
            $ref: '#/components/schemas/ImportInfo'
        documentation:
          $ref: '#/components/schemas/DocumentationInfo'
        file_path:
          type: string
        module_path:
          type: string
        line_range:
          type: array
          items:
            type: integer
          minItems: 2
          maxItems: 2
    FunctionSignature:
      type: object
      required: [name, parameters, is_async, is_method, decorators]
      properties:
        name:
          type: string
        parameters:
          type: array
          items:
            $ref: '#/components/schemas/Parameter'
        return_type:
          type: string
          nullable: true
        is_async:
          type: boolean
        is_method:
          type: boolean
        decorators:
          type: array
          items:
            type: string
    Parameter:
      type: object
      required: [name, kind]
      properties:
        name:
          type: string
        type:
          type: string
          nullable: true
        default_value:
          type: string
          nullable: true
        kind:
          type: string
          enum: [positional, keyword, var_positional, var_keyword]
    FunctionBodyAnalysis:
      type: object
      required: [branches, exceptions, external_calls, complexity]
      properties:
        branches:
          type: array
          items:
            $ref: '#/components/schemas/BranchInfo'
        exceptions:
          type: array
          items:
            $ref: '#/components/schemas/ExceptionInfo'
        external_calls:
          type: array
          items:
            $ref: '#/components/schemas/CallInfo'
        complexity:
          type: integer
    BranchInfo:
      type: object
      required: [type, condition, line_number]
      properties:
        type:
          type: string
          enum: [if, elif, else, match]
        condition:
          type: string
        line_number:
          type: integer
    ExceptionInfo:
      type: object
      required: [type, line_number, context]
      properties:
        type:
          type: string
          enum: [raise, try-except]
        exception_class:
          type: string
          nullable: true
        line_number:
          type: integer
        context:
          type: string
    CallInfo:
      type: object
      required: [function_name, line_number, is_builtin]
      properties:
        function_name:
          type: string
        module:
          type: string
          nullable: true
        line_number:
          type: integer
        is_builtin:
          type: boolean
    ClassContext:
      type: object
      properties:
        class_name:
          type: string
        base_classes:
          type: array
          items:
            type: string
        class_attributes:
          type: array
          items:
            type: string
        other_methods:
          type: array
          items:
            type: string
        is_dataclass:
          type: boolean
    ImportInfo:
      type: object
      required: [module, imported_names, line_number]
      properties:
        module:
          type: string
        imported_names:
          type: array
          items:
            type: string
        alias:
          type: string
          nullable: true
        line_number:
          type: integer
    DocumentationInfo:
      type: object
      required: [inline_comments]
      properties:
        docstring:
          type: string
          nullable: true
        inline_comments:
          type: array
          items:
            $ref: '#/components/schemas/Comment'
    Comment:
      type: object
      required: [text, line_number, is_block_comment]
      properties:
        text:
          type: string
        line_number:
          type: integer
        is_block_comment:
          type: boolean
    Stage1Response:
      type: object
      required:
        - skip_confirmation
        - proceed_to_generation
        - identified_scenarios
        - suggested_additional_scenarios
        - confirmation_question
      properties:
        skip_confirmation:
          type: boolean
        proceed_to_generation:
          type: boolean
        identified_scenarios:
          type: array
          items:
            $ref: '#/components/schemas/IdentifiedScenario'
        suggested_additional_scenarios:
          type: array
          items:
            $ref: '#/components/schemas/IdentifiedScenario'
        confirmation_question:
          type: string
        reason:
          type: string
    IdentifiedScenario:
      type: object
      required: [scenario, confidence, source]
      properties:
        scenario:
          type: string
        confidence:
          type: string
          enum: [high, medium, low]
        source:
          type: string
          enum: [code_analysis, user_description, inference]
        reason:
          type: string
    Stage2Response:
      type: object
      required: [test_code, imports, test_count, coverage_summary]
      properties:
        test_code:
          type: string
        imports:
          type: array
          items:
            type: string
        test_count:
          type: integer
        coverage_summary:
          type: string
        notes:
          type: string
    Stage1Config:
      type: object
      properties:
        maxIdentifiedScenarios:
          type: integer
          default: 5
        maxSuggestedScenarios:
          type: integer
          default: 3
        autoConfirmSimpleFunctions:
          type: boolean
          default: true
        minDescriptionLengthForAutoConfirm:
          type: integer
          default: 100
        temperature:
          type: number
          default: 0.3
        maxTokens:
          type: integer
          default: 2000
    Stage2Config:
      type: object
      properties:
        minTestCount:
          type: integer
          default: 3
        maxTestCount:
          type: integer
          default: 8
        useParametrize:
          type: boolean
          default: true
        generateFixtures:
          type: boolean
          default: true
        temperature:
          type: number
          default: 0.2
        maxTokens:
          type: integer
          default: 3000
    InputGuidance:
      type: object
      properties:
        placeholder:
          type: string
        prompt:
          type: string
        examples:
          type: array
          items:
            type: string
    TokenUsage:
      type: object
      properties:
        prompt_tokens:
          type: integer
        completion_tokens:
          type: integer
        total_tokens:
          type: integer
        estimated_cost_usd:
          type: number
          format: float
    ClientMetadata:
      type: object
      properties:
        client_version:
          type: string
        workspace_hash:
          type: string
        vscode_version:
          type: string
        platform:
          type: string
    ErrorResponse:
      type: object
      required: [error, message]
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true
  responses:
    BadRequest:
      description: Malformed payload or missing fields
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    ValidationError:
      description: Input failed domain validation (e.g., too-short description)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    ServerError:
      description: Unexpected backend failure
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
